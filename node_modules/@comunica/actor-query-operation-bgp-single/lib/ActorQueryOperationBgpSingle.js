"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ActorQueryOperationBgpSingle = void 0;
const bus_query_operation_1 = require("@comunica/bus-query-operation");
/**
 * A comunica Query Operation Actor for BGPs with a single pattern.
 */
class ActorQueryOperationBgpSingle extends bus_query_operation_1.ActorQueryOperationTypedMediated {
    constructor(args) {
        super(args, 'bgp');
    }
    async testOperation(pattern, context) {
        if (pattern.patterns.length !== 1) {
            throw new Error(`Actor ${this.name} can only operate on BGPs with a single pattern.`);
        }
        return true;
    }
    runOperation(pattern, context) {
        // If we have parent metadata, extract the single parent metadata entry.
        if (context && context.has(bus_query_operation_1.KEY_CONTEXT_BGP_PARENTMETADATA)) {
            const metadatas = context.get(bus_query_operation_1.KEY_CONTEXT_BGP_PARENTMETADATA);
            context = context.delete(bus_query_operation_1.KEY_CONTEXT_BGP_PARENTMETADATA);
            context = context.set(bus_query_operation_1.KEY_CONTEXT_PATTERN_PARENTMETADATA, metadatas[0]);
        }
        const output = this.mediatorQueryOperation.mediate({ operation: pattern.patterns[0], context });
        // TODO: We manually trigger the left metadata to be resolved.
        //       If we don't do this, the inner metadata event seems to be lost in some cases,
        //       the left promise above is never resolved, this whole metadata promise is never resolved,
        //       and the application terminates without producing any results.
        /* istanbul ignore next */
        output.then(actualOutput => bus_query_operation_1.getMetadata(actualOutput).catch(() => {
            // Do nothing
        })).catch(() => {
            // Do nothing
        });
        return output;
    }
}
exports.ActorQueryOperationBgpSingle = ActorQueryOperationBgpSingle;
//# sourceMappingURL=ActorQueryOperationBgpSingle.js.map